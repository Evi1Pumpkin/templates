version: 2
deploy:
  steps:
    terraformApply:
      after:
        - name: use ApiKey for login to env0 Remote Backend
          run: |
            cat ~/.terraformrc
            echo 'credentials "backend-pr10727.api.dev.env0.com" {' > ~/.terraformrc
            echo '  token = "$REMOTE_BACKEND_TOKEN"' >> ~/.terraformrc
            echo '}' >> ~/.terraformrc
            cat ~/.terraformrc
        - name: TF_FORCE_LOCAL_BACKEND is...
          run: echo TF_FORCE_LOCAL_BACKEND=$TF_FORCE_LOCAL_BACKEND

        - name: terraform init (as Local CLI User)
          run: terraform -chdir='./local-run' init

        - name: terraform plan (as Local CLI User)
          run: terraform -chdir='./local-run' plan | tee plan-out.txt
        - name: check for errors
          run: |
            ERRORS=`grep -c 'Error' plan-out.txt`
            if [ "$ERRORS" -eq "1" ]; then echo "plan failed" 1>&2 && exit 1; fi
