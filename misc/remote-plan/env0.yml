version: 2
deploy:
  steps:
    terraformApply:
      after:
        - name: use ApiKey for login to env0 Remote Backend
          run: |
            cat ~/.terraformrc
            echo 'credentials "backend-pr10727.api.dev.env0.com" {' > ~/.terraformrc
            echo '  token = "cmp6ZzY5ZTl0d2NsMmF4bjpZXzc1ZDFBV0hVQjhWREE1ajBwUDRMYnpST2FmUjRvXw=="' >> ~/.terraformrc
            echo '}' >> ~/.terraformrc
            cat ~/.terraformrc
        - name: TF_FORCE_LOCAL_BACKEND is...
          run: echo TF_FORCE_LOCAL_BACKEND=$TF_FORCE_LOCAL_BACKEND

        - name: terraform init (as Local CLI User)
          run: terraform -chdir='./local-run' init

        - name: terraform plan (as Local CLI User)
          run: terraform -chdir='./local-run' plan
